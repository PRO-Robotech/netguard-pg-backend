# Integration —Ç–µ—Å—Ç—ã

Integration —Ç–µ—Å—Ç—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –º–µ–∂–¥—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏ —Å–∏—Å—Ç–µ–º—ã, –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ç–µ—Å—Ç–∏—Ä—É—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö.

## –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤

- `internal/infrastructure/repositories/mem/` - In-memory —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
- `internal/infrastructure/repositories/pg/` - PostgreSQL —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π (—Ç–µ—Å—Ç—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç)

## In-Memory —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π

**–§–∞–π–ª**: `internal/infrastructure/repositories/mem/*_test.go`

### –°—Ç–∞—Ç—É—Å: ‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—à–∏–±–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ `mem-reader.go`, –≤—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç —É—Å–ø–µ—à–Ω–æ.

### –¢–µ—Å—Ç–∏—Ä—É–µ–º—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:

#### 1. –ë–∞–∑–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
- `TestMemRegistry` - –û—Å–Ω–æ–≤–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å —Ä–µ–µ—Å—Ç—Ä–æ–º
- `TestMemRegistryAbort` - –û—Ç–∫–∞—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

#### 2. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞–º–∏
- `TestMemRegistryAddressGroups` - –†–∞–±–æ—Ç–∞ —Å –≥—Ä—É–ø–ø–∞–º–∏ –∞–¥—Ä–µ—Å–æ–≤
- `TestMemRegistryAddressGroupBindings` - –ü—Ä–∏–≤—è–∑–∫–∏ –≥—Ä—É–ø–ø –∞–¥—Ä–µ—Å–æ–≤
- `TestMemRegistryAddressGroupPortMappings` - –ü–æ—Ä—Ç–æ–≤—ã–µ –º–∞–ø–ø–∏–Ω–≥–∏
- `TestMemRegistryRuleS2S` - Service-to-Service –ø—Ä–∞–≤–∏–ª–∞
- `TestMemRegistryServiceAliases` - –ê–ª–∏–∞—Å—ã —Å–µ—Ä–≤–∏—Å–æ–≤
- `TestMemRegistrySyncStatus` - –°—Ç–∞—Ç—É—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

#### 3. –û–ø–µ—Ä–∞—Ü–∏–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- `TestSyncServicesWithDifferentOperations` - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:
  - **FullSync** - –ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
  - **Upsert** - –°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
  - **Delete** - –£–¥–∞–ª–µ–Ω–∏–µ  
  - **FullSyncWithScope** - –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –æ–±–ª–∞—Å—Ç—å—é –≤–∏–¥–∏–º–æ—Å—Ç–∏

#### 4. CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏
- `TestListServices` - –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–æ–≤ —Å–µ—Ä–≤–∏—Å–æ–≤
- `TestListAddressGroups` - –ü–æ–ª—É—á–µ–Ω–∏–µ –≥—Ä—É–ø–ø –∞–¥—Ä–µ—Å–æ–≤
- `TestListAddressGroupBindings` - –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–∏–≤—è–∑–æ–∫
- `TestListAddressGroupPortMappings` - –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Ä—Ç–æ–≤—ã—Ö –º–∞–ø–ø–∏–Ω–≥–æ–≤
- `TestListRuleS2S` - –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª S2S

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞

**–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ `mem-reader.go`:**
```go
// –ë—ã–ª–æ (–æ—à–∏–±–∫–∞):
log.Printf("üîç LISTING IEAgAgRule[%d] %s: ...", i, rule.Key(), ...)

// –°—Ç–∞–ª–æ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ):
log.Printf("üîç LISTING IEAgAgRule[%s] %s: ...", i, rule.Key(), ...)
```

**–ü—Ä–∏—á–∏–Ω–∞**: –í —Ü–∏–∫–ª–µ `for i, rule := range rules` –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `i` —è–≤–ª—è–µ—Ç—Å—è –∫–ª—é—á–æ–º map (string), –∞ –Ω–µ –∏–Ω–¥–µ–∫—Å–æ–º (int).

### –ü—Ä–∏–º–µ—Ä —É—Å–ø–µ—à–Ω–æ–≥–æ –ø—Ä–æ–≥–æ–Ω–∞:

```
=== RUN   TestMemRegistry
--- PASS: TestMemRegistry (0.00s)
=== RUN   TestSyncServicesWithDifferentOperations
=== RUN   TestSyncServicesWithDifferentOperations/FullSync
=== RUN   TestSyncServicesWithDifferentOperations/Upsert
=== RUN   TestSyncServicesWithDifferentOperations/Delete
--- PASS: TestSyncServicesWithDifferentOperations (0.00s)
PASS
ok      netguard-pg-backend/internal/infrastructure/repositories/mem    0.663s
```

## PostgreSQL —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `internal/infrastructure/repositories/pg/`

### –°—Ç–∞—Ç—É—Å: ‚ùå –¢–µ—Å—Ç—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç

–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ `go test -v ./internal/infrastructure/repositories/pg/...` –ø–æ–ª—É—á–∞–µ–º:
```
testing: warning: no tests to run
PASS
ok      netguard-pg-backend/internal/infrastructure/repositories/pg     0.201s [no tests to run]
```

### –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è PostgreSQL:

#### 1. –ë–∞–∑–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- –°–æ–∑–¥–∞–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü
- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

#### 2. CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏
- –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π
- –ß—Ç–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π  
- –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π

#### 3. –°–ª–æ–∂–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏
- –ö–∞—Å–∫–∞–¥–Ω—ã–µ —É–¥–∞–ª–µ–Ω–∏—è
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π (constraints)
- –ò–Ω–¥–µ–∫—Å—ã –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- Concurrent access

#### 4. –ú–∏–≥—Ä–∞—Ü–∏–∏
- –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
- –û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–π
- –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ö–µ–º—ã

## –ö–æ–º–∞–Ω–¥—ã –∑–∞–ø—É—Å–∫–∞

```bash
# In-memory —Ç–µ—Å—Ç—ã
go test -v ./internal/infrastructure/repositories/mem/...

# PostgreSQL —Ç–µ—Å—Ç—ã (–ø–æ–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç)
go test -v ./internal/infrastructure/repositories/pg/...

# –í—Å–µ integration —Ç–µ—Å—Ç—ã
make test-integration
```

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è PostgreSQL —Ç–µ—Å—Ç–æ–≤

–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è PostgreSQL —Ç–µ—Å—Ç–æ–≤ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è:

### Docker Compose –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î:
```yaml
services:
  test-postgres:
    image: postgres:14
    environment:
      POSTGRES_PASSWORD: postgres
      POSTGRES_USER: postgres
      POSTGRES_DB: netguard_test
    ports:
      - "5432:5432"
    command: >
      postgres
      -c log_statement=all
      -c log_duration=on
```

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
```bash
export PG_URI="postgres://postgres:postgres@localhost:5432/netguard_test?sslmode=disable"
```

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### 1. –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è PostgreSQL —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: –í—ã—Å–æ–∫–∏–π
**–ü—Ä–∏—á–∏–Ω–∞**: –ö—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è production deployment

### 2. –î–æ–±–∞–≤–∏—Ç—å benchmark —Ç–µ—Å—Ç—ã
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: –°—Ä–µ–¥–Ω–∏–π  
**–¶–µ–ª—å**: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ in-memory vs PostgreSQL

### 3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å CI/CD
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: –í—ã—Å–æ–∫–∏–π
**–¶–µ–ª—å**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ —Å —Ä–µ–∞–ª—å–Ω–æ–π –ë–î

### 4. –¢–µ—Å—Ç—ã –º–∏–≥—Ä–∞—Ü–∏–π
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: –í—ã—Å–æ–∫–∏–π
**–¶–µ–ª—å**: –û–±–µ—Å–ø–µ—á–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Å—Ö–µ–º—ã

## –ó–∞–º–µ—Ç–∫–∏ –ø–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ

In-memory —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è:
- –ë—ã—Å—Ç—Ä—ã—Ö unit —Ç–µ—Å—Ç–æ–≤
- –õ–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- CI/CD pipeline

PostgreSQL —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è:
- Production –æ–∫—Ä—É–∂–µ–Ω–∏—è
- Staging —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- Performance —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

–û–±–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è —Ä–µ–∞–ª–∏–∑—É—é—Ç –æ–¥–Ω–∏ –∏ —Ç–µ –∂–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –∏–∑ `internal/domain/ports/`, —á—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –≤–∑–∞–∏–º–æ–∑–∞–º–µ–Ω—è–µ–º–æ—Å—Ç—å.