# –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ —Ç–µ—Å—Ç–∞–º Netguard-PG-Backend

–≠—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –∏ –ø—Ä–æ–≤–µ—Ä–æ–∫ –≤ –ø—Ä–æ–µ–∫—Ç–µ `netguard-pg-backend`.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–æ–º–ø–ª–µ–∫—Å–Ω—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, –≤–∫–ª—é—á–∞—é—â—É—é –Ω–µ—Å–∫–æ–ª—å–∫–æ —É—Ä–æ–≤–Ω–µ–π:

### 1. Unit —Ç–µ—Å—Ç—ã (Domain —Å–ª–æ–π)
- **–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `./internal/domain/...`
- **–¶–µ–ª—å**: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ –∏ –¥–æ–º–µ–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π
- **–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### 2. Integration —Ç–µ—Å—Ç—ã (Repository —Å–ª–æ–π)
- **In-Memory —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π**: `./internal/infrastructure/repositories/mem/...`
- **PostgreSQL —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π**: `./internal/infrastructure/repositories/pg/...` (—Ç–µ—Å—Ç—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç)
- **–°—Ç–∞—Ç—É—Å**: ‚úÖ In-memory —Ç–µ—Å—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç

### 3. API —Ç–µ—Å—Ç—ã
- **–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `./internal/api/...`
- **–¶–µ–ª—å**: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ gRPC API –∏ REST —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤
- **–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### 4. Application —Ç–µ—Å—Ç—ã
- **Services**: `./internal/application/services/...`
- **Validation**: `./internal/application/validation/...`
- **–°—Ç–∞—Ç—É—Å**: ‚ö†Ô∏è –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ç–µ—Å—Ç—ã —Ç—Ä–µ–±—É—é—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏

### 5. K8s —Ç–µ—Å—Ç—ã
- **–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `./internal/k8s/...`
- **–°—Ç–∞—Ç—É—Å**: ‚ö†Ô∏è –ú–∏–Ω–æ—Ä–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –∫–æ–Ω–≤–µ—Ä—Ç–µ—Ä–∞–º–∏

## –î–µ—Ç–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- [Unit —Ç–µ—Å—Ç—ã (Domain)](./unit-tests.md) - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–º–µ–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π –∏ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏
- [Integration —Ç–µ—Å—Ç—ã](./integration-tests.md) - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤ –∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
- [API —Ç–µ—Å—Ç—ã](./api-tests.md) - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ gRPC –∏ REST API
- [Application —Ç–µ—Å—Ç—ã](./application-tests.md) - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- [K8s —Ç–µ—Å—Ç—ã](./k8s-tests.md) - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Kubernetes –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- [E2E —Ç–µ—Å—Ç—ã](./e2e-tests.md) - End-to-end —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

## –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤

```bash
# –í—Å–µ —Ç–µ—Å—Ç—ã
make test

# Unit —Ç–µ—Å—Ç—ã
make test-unit
go test -v ./internal/domain/...

# Integration —Ç–µ—Å—Ç—ã
make test-integration
go test -v ./internal/infrastructure/repositories/mem/...

# API —Ç–µ—Å—Ç—ã
go test -v ./internal/api/...

# Application —Ç–µ—Å—Ç—ã
go test -v ./internal/application/...

# K8s —Ç–µ—Å—Ç—ã
go test -v ./internal/k8s/...

# –ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞
make test-coverage
```

## –°—Ç–∞—Ç—É—Å —Ç–µ—Å—Ç–æ–≤

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°—Ç–∞—Ç—É—Å | –ü—Ä–æ–±–ª–µ–º—ã | –†–µ—à–µ–Ω–∏–µ |
|-----------|--------|----------|---------|
| Domain | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | –ù–µ—Ç | - |
| Mem Repository | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | –ù–µ—Ç | ‚úÖ 100% |
| PG Repository | ‚ö†Ô∏è –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ | –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –¥–ª—è PostgreSQL | –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ |
| API | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | –ù–µ—Ç | ‚úÖ 100% |
| Application Services | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | –ù–µ—Ç | ‚úÖ 100% |
| Application Validation | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | –ù–µ—Ç | ‚úÖ 100% |
| K8s Registry | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | –í—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ | ‚úÖ 100% |
| Sync Layer | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | Mock –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã | ‚úÖ 100% |

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ mem-reader.go
**–ü—Ä–æ–±–ª–µ–º–∞**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `%d` –¥–ª—è string –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –≤ `log.Printf`
**–†–µ—à–µ–Ω–∏–µ**: –ó–∞–º–µ–Ω–µ–Ω–æ –Ω–∞ `%s`
**–§–∞–π–ª**: `internal/infrastructure/repositories/mem/mem-reader.go:544`

### 2. –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –º–µ—Ç–æ–¥—ã –≤ –º–æ–∫–∞—Ö
**–ü—Ä–æ–±–ª–µ–º–∞**: –ú–æ–∫–∏ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤—ã–≤–∞–ª–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `ports.Reader` –ø–æ–ª–Ω–æ—Å—Ç—å—é
**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–ª–µ–Ω—ã –º–µ—Ç–æ–¥—ã `ListNetworks`, `ListNetworkBindings`, `GetNetworkByID`, `GetNetworkBindingByID`
**–§–∞–π–ª—ã**: –í—Å–µ `*_test.go` –≤ validation –ø–∞–∫–µ—Ç–µ

### 3. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–∏–ø Condition
**–ü—Ä–æ–±–ª–µ–º–∞**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `models.Condition` –≤–º–µ—Å—Ç–æ `metav1.Condition`
**–†–µ—à–µ–Ω–∏–µ**: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã —Ç–∏–ø—ã –∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –∏–º–ø–æ—Ä—Ç—ã
**–§–∞–π–ª**: `internal/application/validation/ieagag_rule_validator_test.go`

### 4. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ ingress –ø–æ—Ä—Ç–æ–≤
**–ü—Ä–æ–±–ª–µ–º–∞**: ConditionManager –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª —Å–µ—Ä–≤–∏—Å—ã –±–µ–∑ –ø–æ—Ä—Ç–æ–≤
**–†–µ—à–µ–Ω–∏–µ**: –£–±—Ä–∞–Ω–∞ –Ω–µ–Ω—É–∂–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ - —Å–µ—Ä–≤–∏—Å –±–µ–∑ –ø–æ—Ä—Ç–æ–≤ –Ω–æ—Ä–º–∞–ª–µ–Ω
**–§–∞–π–ª**: `internal/application/services/condition_manager.go`

### 5. –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π MockWriter –¥–ª—è IEAgAgRules
**–ü—Ä–æ–±–ª–µ–º–∞**: MockWriter –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–ª —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞
**–†–µ—à–µ–Ω–∏–µ**: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –∑–∞—Ö–≤–∞—Ç–∞ –ø—Ä–∞–≤–∏–ª (—Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–π –∑–Ω–∞—á–∏–º—ã–π sync)
**–§–∞–π–ª**: `internal/application/services/service_ieagag_test.go`

### 6. K8s Convert nil vs empty slice
**–ü—Ä–æ–±–ª–µ–º–∞**: `make([]NetworkItem, 0)` —Å–æ–∑–¥–∞–≤–∞–ª `[]` –≤–º–µ—Å—Ç–æ `nil`
**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `len() > 0` –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º slice
**–§–∞–π–ª**: `internal/k8s/registry/convert/addressgroup.go`

### 7. Missing service –≤ K8s Service —Ç–µ—Å—Ç–∞—Ö  
**–ü—Ä–æ–±–ª–µ–º–∞**: MockBackendClient –Ω–µ —Å–æ–¥–µ—Ä–∂–∞–ª service "test-service" –≤ "default" namespace
**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–ª–µ–Ω—ã —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ MockBackendClient
**–§–∞–π–ª**: `internal/k8s/client/mock_backend.go`

### 8. Mock expectations –≤ Sync Syncers
**–ü—Ä–æ–±–ª–µ–º–∞**: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ mock entity –¥–ª—è —Ä–∞–∑–Ω—ã—Ö test cases
**–†–µ—à–µ–Ω–∏–µ**: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ mock objects
**–§–∞–π–ª**: `internal/sync/syncers/address_group_syncer_test.go`

## ‚úÖ –í—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Ä–µ—à–µ–Ω—ã!

üéâ **–°—Ç–∞—Ç—É—Å: –í–°–ï –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ò –ù–ï–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´ –ò–°–ü–†–ê–í–õ–ï–ù–´!**

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —Ä–∞–∑–≤–∏—Ç–∏—è

1. **‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç** - –æ—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–∫—Ä—ã—Ç–∞
2. **–°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è PostgreSQL —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è** - –¥–ª—è production deployment
3. **–î–æ–±–∞–≤–∏—Ç—å performance —Ç–µ—Å—Ç—ã** - –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤ –¥–∞–Ω–Ω—ã—Ö
4. **–†–∞—Å—à–∏—Ä–∏—Ç—å integration —Ç–µ—Å—Ç—ã** - –º–µ–∂–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏
5. **–î–æ–±–∞–≤–∏—Ç—å E2E —Ç–µ—Å—Ç—ã** - –ø–æ–ª–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

## –ú–µ—Ç—Ä–∏–∫–∏ –ø–æ–∫—Ä—ã—Ç–∏—è

–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç—á–µ—Ç–∞ –æ –ø–æ–∫—Ä—ã—Ç–∏–∏ –∫–æ–¥–∞:

```bash
make test-coverage
open coverage.html
```