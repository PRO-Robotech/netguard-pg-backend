# API —Ç–µ—Å—Ç—ã

API —Ç–µ—Å—Ç—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç —Ä–∞–±–æ—Ç—É gRPC API –∏ REST —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ —Å–∏—Å—Ç–µ–º—ã. –í—Å–µ API —Ç–µ—Å—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

## –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤

- `internal/api/netguard/` - gRPC API —Ç–µ—Å—Ç—ã

## –°—Ç–∞—Ç—É—Å: ‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç

```
PASS
ok      netguard-pg-backend/internal/api/netguard       0.251s
```

## –¢–µ—Å—Ç–∏—Ä—É–µ–º—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å API

#### –ë–∞–∑–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- `TestSync` - –û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ—Å—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
  - **–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç**: –ë–∞–∑–æ–≤–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤
  - **–õ–æ–≥–∏–∫–∞**: –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞, –ø–∞—Ä—Å–∏–Ω–≥ –ø–æ—Ä—Ç–æ–≤, —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —É—Å–ª–æ–≤–∏–π
  - **–†–µ–∑—É–ª—å—Ç–∞—Ç**: –°–µ—Ä–≤–∏—Å —É—Å–ø–µ—à–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω —Å 3 —É—Å–ª–æ–≤–∏—è–º–∏

#### –†–∞–∑–ª–∏—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏  
- `TestSyncWithDifferentOperations` - –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π —Ç–µ—Å—Ç —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
  - **Services**: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ FullSync, Upsert, Delete –¥–ª—è —Å–µ—Ä–≤–∏—Å–æ–≤
  - **AddressGroups**: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π –¥–ª—è –≥—Ä—É–ø–ø –∞–¥—Ä–µ—Å–æ–≤
  - **AddressGroupBindings**: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–≤—è–∑–æ–∫ –≥—Ä—É–ø–ø –∞–¥—Ä–µ—Å–æ–≤

### 2. –î–µ—Ç–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã –æ–ø–µ—Ä–∞—Ü–∏–π

#### Services (–°–µ—Ä–≤–∏—Å—ã)
- **FullSync**: –ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
  - –°–æ–∑–¥–∞–Ω–∏–µ web —Å–µ—Ä–≤–∏—Å–∞ (–ø–æ—Ä—Ç 80)
  - –°–æ–∑–¥–∞–Ω–∏–µ db —Å–µ—Ä–≤–∏—Å–∞ (–ø–æ—Ä—Ç 5432)  
  - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ api —Å–µ—Ä–≤–∏—Å–∞ (–ø–æ—Ä—Ç 8080)
  
- **Upsert**: –°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤
  - –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑–æ–≤—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
  - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Ä—Ç–æ–≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
  - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

- **Delete**: –£–¥–∞–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤
  - –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤
  - –£–¥–∞–ª–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è —Å–µ—Ä–≤–∏—Å–æ–≤

#### AddressGroups (–ì—Ä—É–ø–ø—ã –∞–¥—Ä–µ—Å–æ–≤)
- **FullSync**: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≥—Ä—É–ø–ø –∞–¥—Ä–µ—Å–æ–≤
  - internal –≥—Ä—É–ø–ø–∞
  - external –≥—Ä—É–ø–ø–∞
  - dmz –≥—Ä—É–ø–ø–∞

- **Upsert**: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø
- **Delete**: –£–¥–∞–ª–µ–Ω–∏–µ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

#### AddressGroupBindings (–ü—Ä–∏–≤—è–∑–∫–∏)
- **FullSync**: –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–≤—è–∑–æ–∫ –º–µ–∂–¥—É –≥—Ä—É–ø–ø–∞–º–∏ –∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–æ–≤—ã—Ö –º–∞–ø–ø–∏–Ω–≥–æ–≤
  - –í–∞–ª–∏–¥–∞—Ü–∏—è —Å–≤—è–∑–µ–π

### 3. –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∏ —É—Ç–∏–ª–∏—Ç—ã

#### SyncOp –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è
- `TestConvertSyncOp` - –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:
  - **NoOp**: –ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏
  - **FullSync**: –ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
  - **Upsert**: –°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
  - **Delete**: –£–¥–∞–ª–µ–Ω–∏–µ
  - **Invalid**: –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π

#### –°—Ç–∞—Ç—É—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- `TestSyncStatus` - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
  - –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞
  - –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö

### 4. –û–ø–µ—Ä–∞—Ü–∏–∏ —á—Ç–µ–Ω–∏—è (List)

#### Listing –æ–ø–µ—Ä–∞—Ü–∏–∏
- `TestListServices` - –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
  - –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤ –≤ —Ä–∞–∑–Ω—ã—Ö namespace
  - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ namespace
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

- `TestListAddressGroups` - –°–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø –∞–¥—Ä–µ—Å–æ–≤
- `TestListAddressGroupBindings` - –°–ø–∏—Å–æ–∫ –ø—Ä–∏–≤—è–∑–æ–∫
- `TestListAddressGroupPortMappings` - –°–ø–∏—Å–æ–∫ –ø–æ—Ä—Ç–æ–≤—ã—Ö –º–∞–ø–ø–∏–Ω–≥–æ–≤  
- `TestListRuleS2S` - –°–ø–∏—Å–æ–∫ Service-to-Service –ø—Ä–∞–≤–∏–ª

## –ü—Ä–æ–≤–µ—Ä—è–µ–º–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

### 1. –ü–∞—Ä—Å–∏–Ω–≥ –ø–æ—Ä—Ç–æ–≤
–í–æ –≤—Å–µ—Ö —Ç–µ—Å—Ç–∞—Ö –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –ø–∞—Ä—Å–∏–Ω–≥–∞ –ø–æ—Ä—Ç–æ–≤:
```
üîß ParsePortRanges: parsing port string '80'
üîß Split port string into 1 items
üîß Processing item 0: '80'
üîß Item 0 is a single port
üîß Added single port 80
‚úÖ ParsePortRanges: successfully parsed 1 port ranges from '80'
```

### 2. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å–ª–æ–≤–∏—è–º–∏ (Conditions)
–ö–∞–∂–¥—ã–π —Ä–µ—Å—É—Ä—Å –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —É—Å–ª–æ–≤–∏—è:
- **Synced=True**: –†–µ—Å—É—Ä—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω
- **Validated=True**: –†–µ—Å—É—Ä—Å –ø—Ä–æ—à–µ–ª –≤–∞–ª–∏–¥–∞—Ü–∏—é
- **Ready=True**: –†–µ—Å—É—Ä—Å –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

### 3. –ü–æ—Ä—Ç–æ–≤—ã–µ –º–∞–ø–ø–∏–Ω–≥–∏
–î–ª—è AddressGroupBindings –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è:
- –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Ä—Ç–æ–≤—ã—Ö –º–∞–ø–ø–∏–Ω–≥–æ–≤
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –º–∞–ø–ø–∏–Ω–≥–æ–≤
- –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ—Ä—Ç–æ–≤ —Å–µ—Ä–≤–∏—Å–æ–≤

### 4. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ—Å—Ç—å
–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ —Ä–∞–º–∫–∞—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:
```
üíæ COMMIT: Starting database commit operation
üíæ COMMIT: Committing N resources to database
‚úÖ COMMIT: Database commit operation completed successfully
```

## –ö–æ–º–∞–Ω–¥—ã –∑–∞–ø—É—Å–∫–∞

```bash
# –í—Å–µ API —Ç–µ—Å—Ç—ã
go test -v ./internal/api/...

# –° –¥–µ—Ç–∞–ª—å–Ω—ã–º –≤—ã–≤–æ–¥–æ–º
go test -v ./internal/api/netguard/...

# –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç–µ—Å—Ç
go test -v ./internal/api/netguard/ -run TestSync

# –° –ø–æ–∫—Ä—ã—Ç–∏–µ–º
go test -cover ./internal/api/...
```

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ç–µ—Å—Ç–∞—Ö

API —Ç–µ—Å—Ç—ã –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É—é—Ç –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:

### –ü–∞—Ä—Å–∏–Ω–≥ –ø–æ—Ä—Ç–æ–≤:
```
üîß ParsePortRanges: parsing port string '8080'
üîß Split port string into 1 items  
üîß Processing item 0: '8080'
üîß Item 0 is a single port
üîß Added single port 8080
‚úÖ ParsePortRanges: successfully parsed 1 port ranges from '8080'
```

### –†–∞–±–æ—Ç–∞ —Å —É—Å–ª–æ–≤–∏—è–º–∏:
```
üîÑ ConditionManager.ProcessServiceConditions: processing service default/web after commit
‚úÖ ConditionManager: Setting Synced=true for default/web
üîÑ ConditionManager: Validating committed service default/web
‚úÖ ConditionManager: Setting Validated=true for default/web
‚úÖ ConditionManager: Setting Ready=true for default/web
```

### –û–ø–µ—Ä–∞—Ü–∏–∏ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö:
```
üíæ COMMIT: Starting database commit operation
üíæ COMMIT: Committing 1 services to database
üíæ COMMIT: Service[default/web] has 3 conditions
‚úÖ COMMIT: Services committed to database
```

### –ü–æ—Ä—Ç–æ–≤—ã–µ –º–∞–ø–ø–∏–Ω–≥–∏:
```
üîß UpdatePortMapping: updating port mapping for address group default/internal and service default/web
üîß Service has 1 ingress ports
üîß Processing port 0: Protocol=TCP, Port=80
üîß Updated port mapping has 1 service entries
```

## –ü–æ–∫—Ä—ã–≤–∞–µ–º—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

### 1. –ë–∞–∑–æ–≤—ã–µ CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏
- –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤
- –ß—Ç–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤
- –£–¥–∞–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤

### 2. –°–ª–æ–∂–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- –ö–∞—Å–∫–∞–¥–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Å—ã–ª–æ–∫

### 3. –ì—Ä–∞–Ω–∏—á–Ω—ã–µ —Å–ª—É—á–∞–∏
- –†–∞–±–æ—Ç–∞ —Å –ø—É—Å—Ç—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ç–∏–ø–æ–≤

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

API —Ç–µ—Å—Ç—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å:
- –†–∞–∑–¥–µ–ª–µ–Ω–∏—è –Ω–∞ —Å–ª–æ–∏ (API ‚Üí Service ‚Üí Repository)
- –û–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ—Å—Ç–∏ –æ–ø–µ—Ä–∞—Ü–∏–π
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏** –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤ –¥–∞–Ω–Ω—ã—Ö
2. **–†–∞—Å—à–∏—Ä–∏—Ç—å —Ç–µ—Å—Ç—ã –æ—à–∏–±–æ–∫** –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö error cases
3. **–î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã concurrent access** –¥–ª—è –º–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
4. **–°–æ–∑–¥–∞—Ç—å integration —Ç–µ—Å—Ç—ã** —Å —Ä–µ–∞–ª—å–Ω—ã–º gRPC –∫–ª–∏–µ–Ω—Ç–æ–º