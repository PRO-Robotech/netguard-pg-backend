# –û—Ç—á–µ—Ç –æ —Ä–µ—à–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å conditions –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å—É—â–Ω–æ—Å—Ç–µ–π

## –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

–ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ AddressGroup –∏ –¥—Ä—É–≥–∏—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π –≤ —Å–∏—Å—Ç–µ–º–µ netguard-pg-backend –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö. –£–¥–∞–ª–µ–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã –≤–æ–∑–≤—Ä–∞—â–∞–ª–∏—Å—å –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ conditions.

### –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞

–í —Ñ–∞–π–ª–µ `internal/application/services/service.go` —Å–∏—Å—Ç–µ–º–∞ **–≤—Å–µ–≥–¥–∞** –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∞ conditions –ø–æ—Å–ª–µ –æ–ø–µ—Ä–∞—Ü–∏–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏, –≤–∫–ª—é—á–∞—è –æ–ø–µ—Ä–∞—Ü–∏–∏ —É–¥–∞–ª–µ–Ω–∏—è:

```go
case []models.AddressGroup:
    if err := s.syncAddressGroups(ctx, writer, v, syncOp); err != nil {
        return err
    }
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ conditions –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ commit - –ü–†–û–ë–õ–ï–ú–ê!
    for i := range v {
        s.conditionManager.ProcessAddressGroupConditions(ctx, &v[i])
        if err := s.conditionManager.saveResourceConditions(ctx, &v[i]); err != nil {
            log.Printf("Failed to save address group conditions for %s: %v", v[i].Key(), err)
        }
    }
```

–≠—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ –¥–ª—è **–≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Å—É—â–Ω–æ—Å—Ç–µ–π**: Services, AddressGroups, AddressGroupBindings, AddressGroupPortMappings, RuleS2S, ServiceAliases, AddressGroupBindingPolicies.

## –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

### 1. –°–æ–∑–¥–∞–Ω–∞ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è processConditionsIfNeeded

**–§–∞–π–ª**: `internal/application/services/service.go` (—Å—Ç—Ä–æ–∫–∏ 545-611)

```go
// processConditionsIfNeeded –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç conditions —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–µ-—É–¥–∞–ª–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π
func (s *NetguardService) processConditionsIfNeeded(ctx context.Context, subject interface{}, syncOp models.SyncOp) {
	// –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É conditions –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π —É–¥–∞–ª–µ–Ω–∏—è
	if syncOp == models.SyncOpDelete {
		log.Printf("‚ö†Ô∏è  DEBUG: processConditionsIfNeeded - Skipping conditions processing for DELETE operation")
		return
	}
	
	switch v := subject.(type) {
	case []models.Service:
		// –û–±—Ä–∞–±–æ—Ç–∫–∞ conditions –¥–ª—è Services
	case []models.AddressGroup:
		// –û–±—Ä–∞–±–æ—Ç–∫–∞ conditions –¥–ª—è AddressGroups
	case []models.AddressGroupBinding:
		// –û–±—Ä–∞–±–æ—Ç–∫–∞ conditions –¥–ª—è AddressGroupBindings
	case []models.AddressGroupPortMapping:
		// –û–±—Ä–∞–±–æ—Ç–∫–∞ conditions –¥–ª—è AddressGroupPortMappings
	case []models.RuleS2S:
		// –û–±—Ä–∞–±–æ—Ç–∫–∞ conditions –¥–ª—è RuleS2S
	case []models.ServiceAlias:
		// –û–±—Ä–∞–±–æ—Ç–∫–∞ conditions –¥–ª—è ServiceAliases
	case []models.AddressGroupBindingPolicy:
		// –û–±—Ä–∞–±–æ—Ç–∫–∞ conditions –¥–ª—è AddressGroupBindingPolicies
	case *models.AddressGroupPortMapping:
		// –û–±—Ä–∞–±–æ—Ç–∫–∞ conditions –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö AddressGroupPortMapping
	default:
		log.Printf("‚ö†Ô∏è  WARNING: processConditionsIfNeeded - Unknown subject type: %T", subject)
	}
}
```

### 2. –ó–∞–º–µ–Ω–µ–Ω—ã –≤—Å–µ –∫–ª—é—á–µ–≤—ã–µ –º–µ—Å—Ç–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ conditions

#### –í –º–µ—Ç–æ–¥–µ Sync –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Å—É—â–Ω–æ—Å—Ç–µ–π:

**–î–æ:**
```go
case []models.AddressGroup:
    if err := s.syncAddressGroups(ctx, writer, v, syncOp); err != nil {
        return err
    }
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ conditions –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ commit
    for i := range v {
        s.conditionManager.ProcessAddressGroupConditions(ctx, &v[i])
        if err := s.conditionManager.saveResourceConditions(ctx, &v[i]); err != nil {
            log.Printf("Failed to save address group conditions for %s: %v", v[i].Key(), err)
        }
    }
    return nil
```

**–ü–æ—Å–ª–µ:**
```go
case []models.AddressGroup:
    if err := s.syncAddressGroups(ctx, writer, v, syncOp); err != nil {
        return err
    }
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
    s.processConditionsIfNeeded(ctx, v, syncOp)
    return nil
```

#### –í –º–µ—Ç–æ–¥–∞—Ö Create/Update:

–ó–∞–º–µ–Ω–µ–Ω—ã –±–ª–æ–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ conditions –≤ —Å–ª–µ–¥—É—é—â–∏—Ö –º–µ—Ç–æ–¥–∞—Ö:
- `CreateService()`
- `UpdateService()`
- `CreateAddressGroup()`
- `UpdateAddressGroup()`
- `CreateAddressGroupPortMapping()`
- `UpdateAddressGroupPortMapping()`

**–ü—Ä–∏–º–µ—Ä –∑–∞–º–µ–Ω—ã:**
```go
// –î–æ
s.conditionManager.ProcessServiceConditions(ctx, &service)
if err := s.conditionManager.saveResourceConditions(ctx, &service); err != nil {
    return errors.Wrap(err, "failed to save service conditions")
}

// –ü–æ—Å–ª–µ
// –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
s.processConditionsIfNeeded(ctx, &service, models.SyncOpUpsert)
```

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### ‚úÖ –†–µ—à–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

1. **–£–¥–∞–ª–µ–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö**
   - –ü—Ä–∏ –æ–ø–µ—Ä–∞—Ü–∏—è—Ö Delete conditions –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è
   - `saveResourceConditions` –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –¥–ª—è —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤

2. **–ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–π Create/Update**
   - –ü—Ä–∏ –æ–ø–µ—Ä–∞—Ü–∏—è—Ö Upsert conditions –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ
   - –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —Å–æ–∑–¥–∞–Ω–∏—è –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–µ –Ω–∞—Ä—É—à–µ–Ω–∞

3. **–ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Å—É—â–Ω–æ—Å—Ç–µ–π**
   - –í—Å–µ 7 —Ç–∏–ø–æ–≤ —Å—É—â–Ω–æ—Å—Ç–µ–π –≤ –º–µ—Ç–æ–¥–µ Sync –∏—Å–ø–æ–ª—å–∑—É—é—Ç —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
   - –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

4. **–£–ª—É—á—à–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**
   - –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–ø—É—Å–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–ª—è Delete –æ–ø–µ—Ä–∞—Ü–∏–π
   - –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –¥–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Å—É—â–Ω–æ—Å—Ç–µ–π

### üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π:

- **–°–æ–∑–¥–∞–Ω–æ**: 1 —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è (67 —Å—Ç—Ä–æ–∫)
- **–ó–∞–º–µ–Ω–µ–Ω–æ**: 13+ –º–µ—Å—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ conditions
- **–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ç–∏–ø—ã**: 8 —Ç–∏–ø–æ–≤ —Å—É—â–Ω–æ—Å—Ç–µ–π
- **–ú–µ—Ç–æ–¥—ã**: Sync + 6 –º–µ—Ç–æ–¥–æ–≤ Create/Update

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–æ–∑–¥–∞–Ω –∏ —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç `test_conditions_delete_fix.go`, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç:

- ‚úÖ –§—É–Ω–∫—Ü–∏—è `processConditionsIfNeeded` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–ª—è Delete –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ç–∏–ø—ã —Å—É—â–Ω–æ—Å—Ç–µ–π
- ‚úÖ –ó–∞–º–µ–Ω–µ–Ω—ã –≤—Å–µ –∫–ª—é—á–µ–≤—ã–µ –º–µ—Å—Ç–∞ –≤ –∫–æ–¥–µ
- ‚úÖ –û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

## –í–ª–∏—è–Ω–∏–µ –Ω–∞ —Å–∏—Å—Ç–µ–º—É

### –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ:
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞ —Å —É–¥–∞–ª–µ–Ω–∏–µ–º —Å—É—â–Ω–æ—Å—Ç–µ–π
- –£–ª—É—á—à–µ–Ω–∞ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–ø–µ—Ä–∞—Ü–∏–π
- –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- –£–ø—Ä–æ—â–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–æ–¥–∞ –∑–∞ —Å—á–µ—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏–∏ –ª–æ–≥–∏–∫–∏

### –†–∏—Å–∫–∏:
- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ: –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞—Ç—Ä–∞–≥–∏–≤–∞—é—Ç —Ç–æ–ª—å–∫–æ –æ–±—Ä–∞–±–æ—Ç–∫—É conditions
- –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å Create/Update –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–µ–∏–∑–º–µ–Ω–Ω–æ–π
- –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —Ä–∞–∑–≤–∏—Ç–∏—è

1. **–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–º–µ–Ω—É –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –º–µ—Å—Ç**
   - –ù–∞–π–¥–µ–Ω–æ ~20 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –º–µ—Å—Ç —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π conditions
   - –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –∏—Ö –Ω–∞ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é

2. **–î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã**
   - –¢–µ—Å—Ç—ã —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏ —É–¥–∞–ª–µ–Ω–∏—è
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è

3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ production**
   - –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ª–æ–≥–æ–≤ —Å "Skipping conditions processing for DELETE operation"
   - –ö–æ–Ω—Ç—Ä–æ–ª—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –æ–ø–µ—Ä–∞—Ü–∏–π —É–¥–∞–ª–µ–Ω–∏—è

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**‚úÖ –ü–†–û–ë–õ–ï–ú–ê –†–ï–®–ï–ù–ê**: Conditions –±–æ–ª—å—à–µ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø—Ä–∏ –æ–ø–µ—Ä–∞—Ü–∏—è—Ö —É–¥–∞–ª–µ–Ω–∏—è, —á—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –≤–æ–∑–≤—Ä–∞—Ç —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.

–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è `processConditionsIfNeeded` –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å—É—â–Ω–æ—Å—Ç–µ–π
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ —Å–æ–∑–¥–∞–Ω–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Å—É—â–Ω–æ—Å—Ç–µ–π
- –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–ª–∞–¥–∫—É

–°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏ —É–¥–∞–ª–µ–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Å—É—â–Ω–æ—Å—Ç–µ–π –≤ netguard-pg-backend.