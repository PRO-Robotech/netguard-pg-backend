syntax = "proto3";
package netguard.v1;
option go_package = "netguard-pg-backend/protos/pkg/api/netguard;netguard";
import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";
import "google/api/annotations.proto";
import "protoc-gen-openapiv2/options/annotations.proto";
import "common/ip-transport.proto";

option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_swagger) = {
  info: {
    title: "Netguard API";
    version: "1.0";
  };
  external_docs: {
    url: "https://github.com/yourusername/netguard-pg-backend";
    description: "Documentation";
  }
  schemes: [HTTP];
  consumes: "application/json";
  produces: "application/json";
};

// Service - represents a service with ports
message Service {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
    json_schema: {
      required: ["self_ref"]
    }
  };
  ResourceIdentifier self_ref = 1;
  string description = 3;
  repeated IngressPort ingress_ports = 4;
  repeated AddressGroupRef address_groups = 5;
  Meta meta = 6;
}

// IngressPort - defines a port configuration for ingress traffic
message IngressPort {
  common.Networks.NetIP.Transport protocol = 1;
  string port = 2;
  string description = 3;
}

// ResourceIdentifier - uniquely identifies a resource
message ResourceIdentifier {
  string name = 1;
  string namespace = 2;
}

// Condition - kubernetes condition for resource status
message Condition {
  string type = 1;
  string status = 2;
  int64 observed_generation = 3;
  google.protobuf.Timestamp last_transition_time = 4;
  string reason = 5;
  string message = 6;
}

// Meta - kubernetes system metadata stored round-trip.
message Meta {
  string uid = 1;
  string resource_version = 2;
  int64 generation = 3;
  google.protobuf.Timestamp creation_ts = 4;
  map<string,string> labels = 5;
  map<string,string> annotations = 6;
  
  // Status management - формируется Backend, отображается в Status клиентам
  repeated Condition conditions = 7;
  int64 observed_generation = 8;
}

// AddressGroupRef - reference to an address group
message AddressGroupRef {
  ResourceIdentifier identifier = 1;
}

// ServiceRef - reference to a service
message ServiceRef {
  ResourceIdentifier identifier = 1;
}

// RuleAction - action for rules and address groups
enum RuleAction {
  // UNDEFINED - undefined action (should not be used)
  UNDEFINED = 0;
  
  // DROP - drops network packet  
  DROP = 1;
  
  // ACCEPT - accepts network packet
  ACCEPT = 2;
}

// AddressGroup - represents an address group configuration for Netguard
message AddressGroup {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
    json_schema: {
      required: ["self_ref", "default_action"]
    }
  };
  ResourceIdentifier self_ref = 1;
  RuleAction default_action = 2;  // Default action for the address group (ACCEPT/DROP)
  bool logs = 3;                  // Whether to enable logs
  bool trace = 4;                 // Whether to enable trace
  Meta meta = 6;
}

// AddressGroupBinding - binding between a service and an address group
message AddressGroupBinding {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
    json_schema: {
      required: ["self_ref", "service_ref", "address_group_ref"]
    }
  };
  ResourceIdentifier self_ref = 1;
  ServiceRef service_ref = 3;
  AddressGroupRef address_group_ref = 4;
  Meta meta = 6;
}

// ProtocolPorts - mapping of protocols to port ranges
message ProtocolPorts {
  map<string, PortRanges> ports = 1;
}

// PortRange - range of ports
message PortRange {
  int32 start = 1;
  int32 end = 2;
}

// PortRanges - list of port ranges
message PortRanges {
  repeated PortRange ranges = 1;
}

// ServicePortsRef - reference to a service and its allowed ports
message ServicePortsRef {
  ResourceIdentifier identifier = 1;
  ProtocolPorts ports = 2;
}

// AddressGroupPortMapping - mapping between an address group and allowed ports
message AddressGroupPortMapping {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
    json_schema: {
      required: ["self_ref"]
    }
  };
  ResourceIdentifier self_ref = 1;
  repeated ServicePortsRef access_ports = 3;
  Meta meta = 6;
}

// ServiceAlias - alias for a service
message ServiceAlias {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
    json_schema: {
      required: ["name", "namespace", "service_ref"]
    }
  };
  ResourceIdentifier self_ref = 1;
  ServiceRef service_ref = 2;
  Meta meta = 6;
}

// AddressGroupBindingPolicy - policy allowing binding of a service to an address group
message AddressGroupBindingPolicy {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
    json_schema: {
      required: ["self_ref", "service_ref", "address_group_ref"]
    }
  };
  ResourceIdentifier self_ref = 1;
  ServiceRef service_ref = 2;
  AddressGroupRef address_group_ref = 3;
  Meta meta = 6;
}

// RuleS2S - rule between two services
message RuleS2S {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
    json_schema: {
      required: ["name", "namespace", "traffic", "service_local_ref", "service_ref"]
    }
  };
  ResourceIdentifier self_ref = 1;
  common.Traffic traffic = 2;
  ServiceRef service_local_ref = 3;
  ServiceRef service_ref = 4;
  Meta meta = 6;
}

// IEAgAgRule - rule between two address groups
message IEAgAgRule {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
    json_schema: {
      required: ["self_ref", "transport", "traffic", "address_group_local", "address_group", "action"]
    }
  };
  ResourceIdentifier self_ref = 1;
  common.Networks.NetIP.Transport transport = 2;
  common.Traffic traffic = 3;
  AddressGroupRef address_group_local = 4;
  AddressGroupRef address_group = 5;
  repeated PortSpec ports = 6;
  RuleAction action = 7;
  bool logs = 8;
  int32 priority = 9;
  Meta meta = 10;
}

// PortSpec - port specification
message PortSpec {
  string source = 1;
  string destination = 2;
}

// SyncStatusResp - sync status
message SyncStatusResp {
  google.protobuf.Timestamp updated_at = 1;
}

// SyncOp - sync operation type
enum SyncOp {
  // NoOp - no operation defined (default)
  NoOp = 0;

  // FullSync - Delete+Insert+Update operations (default)
  FullSync = 1;

  // Upsert - Insert+Update operations
  Upsert = 2;

  // Delete - Delete operation
  Delete = 3;
}

// SyncServices - subject of Services to sync
message SyncServices {
  repeated Service services = 1;
}

// SyncAddressGroups - subject of Address Groups to sync
message SyncAddressGroups {
  repeated AddressGroup address_groups = 1;
}

// SyncAddressGroupBindings - subject of Address Group Bindings to sync
message SyncAddressGroupBindings {
  repeated AddressGroupBinding address_group_bindings = 1;
}

// SyncAddressGroupPortMappings - subject of Address Group Port Mappings to sync
message SyncAddressGroupPortMappings {
  repeated AddressGroupPortMapping address_group_port_mappings = 1;
}

// SyncRuleS2S - subject of Rule S2S to sync
message SyncRuleS2S {
  repeated RuleS2S rule_s2s = 1;
}

// SyncServiceAliases - subject of Service Aliases to sync
message SyncServiceAliases {
  repeated ServiceAlias service_aliases = 1;
}

// SyncAddressGroupBindingPolicies - subject of Address Group Binding Policies to sync
message SyncAddressGroupBindingPolicies {
  repeated AddressGroupBindingPolicy address_group_binding_policies = 1;
}

// SyncIEAgAgRules - subject of IEAgAgRules to sync
message SyncIEAgAgRules {
  repeated IEAgAgRule ieagag_rules = 1;
}

// Requests and responses for API methods

// ListServicesReq - request to list services
message ListServicesReq {
  repeated ResourceIdentifier identifiers = 1;
}

// ListServicesResp - response with list of services
message ListServicesResp {
  repeated Service items = 1;
}

// GetServiceReq - request to get a specific service
message GetServiceReq {
  ResourceIdentifier identifier = 1;
}

// GetServiceResp - response with a specific service
message GetServiceResp {
  Service service = 1;
}

// ListAddressGroupsReq - request to list address groups
message ListAddressGroupsReq {
  repeated ResourceIdentifier identifiers = 1;
}

// ListAddressGroupsResp - response with list of address groups
message ListAddressGroupsResp {
  repeated AddressGroup items = 1;
}

// GetAddressGroupReq - request to get a specific address group
message GetAddressGroupReq {
  ResourceIdentifier identifier = 1;
}

// GetAddressGroupResp - response with a specific address group
message GetAddressGroupResp {
  AddressGroup address_group = 1;
}

// ListAddressGroupBindingsReq - request to list address group bindings
message ListAddressGroupBindingsReq {
  repeated ResourceIdentifier identifiers = 1;
}

// ListAddressGroupBindingsResp - response with list of address group bindings
message ListAddressGroupBindingsResp {
  repeated AddressGroupBinding items = 1;
}

// ListAddressGroupPortMappingsReq - request to list address group port mappings
message ListAddressGroupPortMappingsReq {
  repeated ResourceIdentifier identifiers = 1;
}

// ListAddressGroupPortMappingsResp - response with list of address group port mappings
message ListAddressGroupPortMappingsResp {
  repeated AddressGroupPortMapping items = 1;
}

// ListRuleS2SReq - request to list rule s2s
message ListRuleS2SReq {
  repeated ResourceIdentifier identifiers = 1;
}

// ListRuleS2SResp - response with list of rule s2s
message ListRuleS2SResp {
  repeated RuleS2S items = 1;
}

// ListServiceAliasesReq - request to list service aliases
message ListServiceAliasesReq {
  repeated ResourceIdentifier identifiers = 1;
}

// ListServiceAliasesResp - response with list of service aliases
message ListServiceAliasesResp {
  repeated ServiceAlias items = 1;
}

// GetAddressGroupBindingReq - request to get a specific address group binding
message GetAddressGroupBindingReq {
  ResourceIdentifier identifier = 1;
}

// GetAddressGroupBindingResp - response with a specific address group binding
message GetAddressGroupBindingResp {
  AddressGroupBinding address_group_binding = 1;
}

// GetAddressGroupPortMappingReq - request to get a specific address group port mapping
message GetAddressGroupPortMappingReq {
  ResourceIdentifier identifier = 1;
}

// GetAddressGroupPortMappingResp - response with a specific address group port mapping
message GetAddressGroupPortMappingResp {
  AddressGroupPortMapping address_group_port_mapping = 1;
}

// GetRuleS2SReq - request to get a specific rule s2s
message GetRuleS2SReq {
  ResourceIdentifier identifier = 1;
}

// GetRuleS2SResp - response with a specific rule s2s
message GetRuleS2SResp {
  RuleS2S rule_s2s = 1;
}

// GetServiceAliasReq - request to get a specific service alias
message GetServiceAliasReq {
  ResourceIdentifier identifier = 1;
}

// GetServiceAliasResp - response with a specific service alias
message GetServiceAliasResp {
  ServiceAlias service_alias = 1;
}

// ListAddressGroupBindingPoliciesReq - request to list address group binding policies
message ListAddressGroupBindingPoliciesReq {
  repeated ResourceIdentifier identifiers = 1;
}

// ListAddressGroupBindingPoliciesResp - response with list of address group binding policies
message ListAddressGroupBindingPoliciesResp {
  repeated AddressGroupBindingPolicy items = 1;
}

// GetAddressGroupBindingPolicyReq - request to get a specific address group binding policy
message GetAddressGroupBindingPolicyReq {
  ResourceIdentifier identifier = 1;
}

// GetAddressGroupBindingPolicyResp - response with a specific address group binding policy
message GetAddressGroupBindingPolicyResp {
  AddressGroupBindingPolicy address_group_binding_policy = 1;
}

// ListIEAgAgRulesReq - request to list IEAgAgRules
message ListIEAgAgRulesReq {
  repeated ResourceIdentifier identifiers = 1;
}

// ListIEAgAgRulesResp - response with list of IEAgAgRules
message ListIEAgAgRulesResp {
  repeated IEAgAgRule items = 1;
}

// GetIEAgAgRuleReq - request to get a specific IEAgAgRule
message GetIEAgAgRuleReq {
  ResourceIdentifier identifier = 1;
}

// GetIEAgAgRuleResp - response with a specific IEAgAgRule
message GetIEAgAgRuleResp {
  IEAgAgRule ieagag_rule = 1;
}

// SyncReq - request to sync
message SyncReq {
  // Sync operation to apply
  SyncOp sync_op = 1;

  // One of subject
  oneof subject {
    // Subject of Services
    SyncServices services = 2;

    // Subject of Address Groups
    SyncAddressGroups address_groups = 3;

    // Subject of Address Group Bindings
    SyncAddressGroupBindings address_group_bindings = 4;

    // Subject of Address Group Port Mappings
    SyncAddressGroupPortMappings address_group_port_mappings = 5;

    // Subject of Rule S2S
    SyncRuleS2S rule_s2s = 6;

    // Subject of Service Aliases
    SyncServiceAliases service_aliases = 7;

    // Subject of Address Group Binding Policies
    SyncAddressGroupBindingPolicies address_group_binding_policies = 8;

    // Subject of IEAgAgRules
    SyncIEAgAgRules ieagag_rules = 9;
  }
}

// Service definition
service NetguardService {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_tag) = {
    description: "Netguard API service"
  };

  // Sync - syncs data in DB
  rpc Sync(SyncReq) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      post: "/v1/sync"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      description: "Sync: makes changes in DB";
    };
  }

  // SyncStatus - gets last succeeded update DB status
  rpc SyncStatus(google.protobuf.Empty) returns(SyncStatusResp) {
    option (google.api.http) = {
      get: "/v1/sync/status"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      description: "SyncStatus: gets last succeeded update DB status";
    };
  }

  // ListServices - gets list of services
  rpc ListServices(ListServicesReq) returns (ListServicesResp) {
    option (google.api.http) = {
      get: "/v1/services"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      description: "ListServices: gets list of services";
    };
  }

  // GetService - gets a specific service by ID
  rpc GetService(GetServiceReq) returns (GetServiceResp) {
    option (google.api.http) = {
      get: "/v1/services/{identifier.namespace}/{identifier.name}"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      description: "GetService: gets a specific service by ID";
    };
  }

  // ListAddressGroups - gets list of address groups
  rpc ListAddressGroups(ListAddressGroupsReq) returns (ListAddressGroupsResp) {
    option (google.api.http) = {
      get: "/v1/address-groups"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      description: "ListAddressGroups: gets list of address groups";
    };
  }

  // GetAddressGroup - gets a specific address group by ID
  rpc GetAddressGroup(GetAddressGroupReq) returns (GetAddressGroupResp) {
    option (google.api.http) = {
      get: "/v1/address-groups/{identifier.namespace}/{identifier.name}"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      description: "GetAddressGroup: gets a specific address group by ID";
    };
  }

  // ListAddressGroupBindings - gets list of address group bindings
  rpc ListAddressGroupBindings(ListAddressGroupBindingsReq) returns (ListAddressGroupBindingsResp) {
    option (google.api.http) = {
      get: "/v1/address-group-bindings"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      description: "ListAddressGroupBindings: gets list of address group bindings";
    };
  }

  // GetAddressGroupBinding - gets a specific address group binding by ID
  rpc GetAddressGroupBinding(GetAddressGroupBindingReq) returns (GetAddressGroupBindingResp) {
    option (google.api.http) = {
      get: "/v1/address-group-bindings/{identifier.namespace}/{identifier.name}"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      description: "GetAddressGroupBinding: gets a specific address group binding by ID";
    };
  }

  // ListAddressGroupPortMappings - gets list of address group port mappings
  rpc ListAddressGroupPortMappings(ListAddressGroupPortMappingsReq) returns (ListAddressGroupPortMappingsResp) {
    option (google.api.http) = {
      get: "/v1/address-group-port-mappings"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      description: "ListAddressGroupPortMappings: gets list of address group port mappings";
    };
  }

  // GetAddressGroupPortMapping - gets a specific address group port mapping by ID
  rpc GetAddressGroupPortMapping(GetAddressGroupPortMappingReq) returns (GetAddressGroupPortMappingResp) {
    option (google.api.http) = {
      get: "/v1/address-group-port-mappings/{identifier.namespace}/{identifier.name}"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      description: "GetAddressGroupPortMapping: gets a specific address group port mapping by ID";
    };
  }

  // ListRuleS2S - gets list of rule s2s
  rpc ListRuleS2S(ListRuleS2SReq) returns (ListRuleS2SResp) {
    option (google.api.http) = {
      get: "/v1/rule-s2s"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      description: "ListRuleS2S: gets list of rule s2s";
    };
  }

  // GetRuleS2S - gets a specific rule s2s by ID
  rpc GetRuleS2S(GetRuleS2SReq) returns (GetRuleS2SResp) {
    option (google.api.http) = {
      get: "/v1/rule-s2s/{identifier.namespace}/{identifier.name}"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      description: "GetRuleS2S: gets a specific rule s2s by ID";
    };
  }

  // ListServiceAliases - gets list of service aliases
  rpc ListServiceAliases(ListServiceAliasesReq) returns (ListServiceAliasesResp) {
    option (google.api.http) = {
      get: "/v1/service-aliases"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      description: "ListServiceAliases: gets list of service aliases";
    };
  }

  // GetServiceAlias - gets a specific service alias by ID
  rpc GetServiceAlias(GetServiceAliasReq) returns (GetServiceAliasResp) {
    option (google.api.http) = {
      get: "/v1/service-aliases/{identifier.namespace}/{identifier.name}"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      description: "GetServiceAlias: gets a specific service alias by ID";
    };
  }

  // ListAddressGroupBindingPolicies - gets list of address group binding policies
  rpc ListAddressGroupBindingPolicies(ListAddressGroupBindingPoliciesReq) returns (ListAddressGroupBindingPoliciesResp) {
    option (google.api.http) = {
      get: "/v1/address-group-binding-policies"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      description: "ListAddressGroupBindingPolicies: gets list of address group binding policies";
    };
  }

  // GetAddressGroupBindingPolicy - gets a specific address group binding policy by ID
  rpc GetAddressGroupBindingPolicy(GetAddressGroupBindingPolicyReq) returns (GetAddressGroupBindingPolicyResp) {
    option (google.api.http) = {
      get: "/v1/address-group-binding-policies/{identifier.namespace}/{identifier.name}"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      description: "GetAddressGroupBindingPolicy: gets a specific address group binding policy by ID";
    };
  }

  // ListIEAgAgRules - gets list of IEAgAgRules
  rpc ListIEAgAgRules(ListIEAgAgRulesReq) returns (ListIEAgAgRulesResp) {
    option (google.api.http) = {
      get: "/v1/ieagag-rules"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      description: "ListIEAgAgRules: gets list of IEAgAgRules";
    };
  }

  // GetIEAgAgRule - gets a specific IEAgAgRule by ID
  rpc GetIEAgAgRule(GetIEAgAgRuleReq) returns (GetIEAgAgRuleResp) {
    option (google.api.http) = {
      get: "/v1/ieagag-rules/{identifier.namespace}/{identifier.name}"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      description: "GetIEAgAgRule: gets a specific IEAgAgRule by ID";
    };
  }
}
